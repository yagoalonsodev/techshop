{% extends "base.html" %}

{% block title %}{{ _('page_checkout') }} - TechShop{% endblock %}

{% block content %}
<div class="checkout-container">
    <h2>{{ _('page_checkout') }}</h2>
    
    {% if cart_products %}
        <div class="cart-summary">
            <h3>{{ _('cart_summary') }}</h3>
            <div class="cart-items">
                {% for product, quantity, images in cart_products %}
                    <div class="cart-item">
                        <div class="cart-item-image">
                            {% if images %}
                                <img src="{{ images[0] }}" alt="Imatge de {{ product.name }}" loading="lazy">
                            {% else %}
                                <div class="cart-item-placeholder">{{ _('no_image') }}</div>
                            {% endif %}
                        </div>
                        <div class="cart-item-details">
                            <span class="product-name">{{ product.name }}</span>
                            <span class="quantity">x{{ quantity }}</span>
                        </div>
                        <span class="cart-item-price">{{ "%.2f"|format(product.price * quantity) }}€</span>
                        
                        <form method="POST" action="{{ url_for('remove_from_cart') }}" class="remove-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="product_id" value="{{ product.id }}">
                            <button type="submit" class="btn btn-danger btn-small">{{ _('remove') }}</button>
                        </form>
                    </div>
                {% endfor %}
            </div>
            
            <div class="cart-total">
                <strong>{{ _('total') }}: {{ "%.2f"|format(cart_total) }}€</strong>
            </div>
        </div>

        <div class="checkout-form">
            <h3>{{ _('user_data') }}</h3>
            
            {% if current_user %}
                {# Usuari autenticat: només demanar adreça #}
                <form method="POST" action="{{ url_for('process_order') }}" id="checkout-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="checkout_type" value="authenticated">
                    
                    <div class="user-info-summary">
                        <p><strong>{{ _('buying_as') }}:</strong> {{ current_user.username }}</p>
                        <p><strong>{{ _('email_label') }}</strong> {{ current_user.email }}</p>
                    </div>

                    <div class="form-group">
                        <label for="address">{{ _('label_address') }}</label>
                        <textarea id="address" 
                                  name="address" 
                                  minlength="10"
                                  maxlength="500"
                                  title="{{ _('help_address') }}"
                                  required
                                  class="form-textarea"
                                  rows="3"
                                  placeholder="{{ _('help_address_placeholder') }}"></textarea>
                        <small>{{ _('help_address') }}</small>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-success btn-large">
                            {{ _('btn_confirm') }} {{ _('checkout') }}
                        </button>
                        <a href="{{ url_for('show_products') }}" class="btn btn-secondary">
                            {{ _('continue_shopping') }}
                        </a>
                    </div>
                </form>
            {% else %}
                {# Usuari no autenticat: preguntar com vol comprar #}
                <div id="checkout-choice" class="checkout-choice">
                    <h4>{{ _('prefer_guest') }}</h4>
                    <div class="choice-buttons">
                        <button type="button" id="btn-login" class="btn btn-primary btn-large">
                            {{ _('btn_login') }}
                        </button>
                        <button type="button" id="btn-guest" class="btn btn-secondary btn-large">
                            {{ _('checkout_as_guest') }}
                        </button>
                    </div>
                </div>

                {# Formulari d'inici de sessió (ocult inicialment) #}
                <div id="login-section" class="checkout-section" style="display: none;">
                    <h4>{{ _('page_login') }}</h4>
                    <form method="POST" action="{{ url_for('login') }}" id="checkout-login-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="next" value="{{ url_for('checkout') }}">
                        
                        <div class="form-group">
                            <label for="login-username">{{ _('label_username') }}</label>
                            <input type="text" 
                                   id="login-username" 
                                   name="username" 
                                   minlength="4" 
                                   maxlength="20" 
                                   pattern="[a-zA-Z0-9_]+"
                                   required
                                   class="form-input"
                                   autocomplete="username">
                        </div>

                        <div class="form-group">
                            <label for="login-password">{{ _('label_password') }}</label>
                            <input type="password" 
                                   id="login-password" 
                                   name="password" 
                                   minlength="8"
                                   required
                                   class="form-input"
                                   autocomplete="current-password">
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                {{ _('btn_login') }}
                            </button>
                            <a href="{{ url_for('register') }}" class="btn btn-link">
                                {{ _('btn_register') }}
                            </a>
                            <button type="button" id="btn-back-from-login" class="btn btn-secondary">
                                {{ _('btn_back') }}
                            </button>
                        </div>
                    </form>
                </div>

                {# Formulari d'invitat (ocult inicialment) #}
                <div id="guest-section" class="checkout-section" style="display: none;">
                    <h4>{{ _('checkout_as_guest') }}</h4>
            <form method="POST" action="{{ url_for('process_order') }}" id="checkout-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="checkout_type" value="guest">
                        
                <div class="form-group">
                            <label for="username">{{ _('label_username') }}</label>
                    <input type="text" 
                           id="username" 
                           name="username" 
                           minlength="4" 
                           maxlength="20" 
                           pattern="[a-zA-Z0-9_]+"
                                   title="{{ _('help_username') }}"
                           required
                                   class="form-input"
                                   autocomplete="username">
                            <small>{{ _('help_username') }}</small>
                </div>

                <div class="form-group">
                            <label for="password">{{ _('label_password') }}</label>
                    <input type="password" 
                           id="password" 
                           name="password" 
                           minlength="8"
                           maxlength="100"
                           pattern="^(?=.*[A-Za-z])(?=.*\d).{8,}$"
                                   title="{{ _('help_password') }}"
                           required
                                   class="form-input"
                                   autocomplete="new-password">
                            <small>{{ _('help_password') }}</small>
                </div>

                <div class="form-group">
                            <label for="email">{{ _('label_email') }}</label>
                    <input type="email" 
                           id="email" 
                           name="email" 
                           pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}"
                                   title="{{ _('help_email') }}"
                           required
                           class="form-input"
                                   placeholder="exemple@correu.com"
                                   autocomplete="email">
                            <small>{{ _('help_email') }}</small>
                </div>

                <div class="form-group">
                            <label for="address">{{ _('label_address') }}</label>
                    <textarea id="address" 
                              name="address" 
                              minlength="10"
                              maxlength="500"
                                      title="{{ _('help_address') }}"
                              required
                              class="form-textarea"
                              rows="3"
                                      placeholder="{{ _('help_address_placeholder') }}"></textarea>
                            <small>{{ _('help_address') }}</small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success btn-large">
                                {{ _('btn_confirm') }} {{ _('checkout') }}
                            </button>
                            <button type="button" id="btn-back-from-guest" class="btn btn-secondary">
                                {{ _('btn_back') }}
                    </button>
                        </div>
                    </form>
                </div>
            {% endif %}
        </div>
    {% else %}
        <div class="empty-cart">
            <h3>{{ _('cart_empty') }}</h3>
            <p>{{ _('add_products_to_cart') }}</p>
            <a href="{{ url_for('show_products') }}" class="btn btn-primary">
                {{ _('view_products') }}
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}