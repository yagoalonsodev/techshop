{% extends "base.html" %}

{% block title %}{{ _('page_products') }} - TechShop{% endblock %}

{% block content %}
<div class="products-container">
    <h2>{{ _('available_products') }}</h2>

    <div class="highlight-sections">
        {% if user_recommendations %}
            <section class="recommendations-block">
                <header class="section-header">
                    <h3>{{ _('recommended_for_you') }}</h3>
                    <p>{{ _('based_on_purchases') }}</p>
                </header>
                <div class="recommendations-grid">
                    {% for product, total_sold in user_recommendations %}
                        <article class="recommendation-card">
                            <h4>{{ product.name }}</h4>
                            <p class="recommendation-price">{{ "%.2f"|format(product.price) }}€</p>
                            <p class="recommendation-meta">{{ _('units_sold') }}: {{ total_sold }}</p>
                        </article>
                    {% endfor %}
                </div>
            </section>
        {% endif %}

        {% if recommendations %}
            <section class="recommendations-block">
                <header class="section-header">
                    <h3>{{ _('trends') }}</h3>
                    <p>{{ _('most_sold') }}</p>
                </header>
                <div class="trend-carousel">
                    <button class="trend-nav trend-nav-prev" type="button" aria-label="{{ _('previous_product') }}">&larr;</button>
                    <div class="trend-slides">
                        {% for product, total_sold in recommendations %}
                            {% set trend_images = product_images.get(product.id, []) %}
                            <article class="trend-slide{% if loop.first %} is-active{% endif %}" data-index="{{ loop.index0 }}" aria-hidden="{{ 'false' if loop.first else 'true' }}">
                                {% if trend_images %}
                                    <div class="trend-image">
                                        <img src="{{ trend_images[0] }}" alt="{{ _('product_col') }} destacat {{ product.name }}" loading="lazy">
                                    </div>
                                {% else %}
                                    <div class="trend-image trend-image-placeholder">
                                        <span>{{ _('image_not_available') }}</span>
                                    </div>
                                {% endif %}
                                <div class="trend-info">
                                    <h4>{{ product.name }}</h4>
                                    <p class="trend-price">{{ "%.2f"|format(product.price) }}€</p>
                                    <p class="trend-meta">{{ total_sold }} {{ _('units_sold') }}</p>
                                </div>
                            </article>
                        {% endfor %}
                    </div>
                    <button class="trend-nav trend-nav-next" type="button" aria-label="{{ _('next_product') }}">&rarr;</button>
                </div>
            </section>
        {% endif %}
    </div>
    
    {% if products %}
        <div class="products-grid">
            {% for product in products %}
                <div class="product-card">
                    {% set images = product_images.get(product.id, []) %}
                    <div class="product-gallery">
                        {% if images %}
                            <div class="product-gallery-main">
                                <img src="{{ images[0] }}"
                                     alt="{{ _('image_main') }} {{ product.name }}"
                                     loading="lazy"
                                     class="product-main-image"
                                     data-default="{{ images[0] }}">
                            </div>
                            {% if images|length > 1 %}
                                <div class="product-gallery-thumbs">
                                    {% for image in images %}
                                        <img src="{{ image }}"
                                             alt="{{ _('image_thumbnail') }} {{ product.name }}"
                                             loading="lazy"
                                             class="product-thumb{% if loop.first %} is-active{% endif %}"
                                             data-image="{{ image }}"
                                             tabindex="0"
                                             role="button"
                                             aria-label="{{ _('show_image') }} {{ loop.index }} {{ _('of') }} {{ images|length }} {{ _('for') }} {{ product.name }}">
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="product-gallery-placeholder">
                                <span>{{ _('image_not_available') }}</span>
                            </div>
                        {% endif %}
                    </div>
                    <h3><a href="{{ url_for('main.product_detail', product_id=product.id) }}">{{ product.name }}</a></h3>
                    <p class="price">{{ "%.2f"|format(product.price) }}€</p>
                    <p class="stock">{{ _('stock_available') }} {{ product.stock }} {{ _('units') }}</p>
                    
                    {% if product.stock > 0 %}
                        {% if current_user and current_user.account_type == 'company' %}
                            <p class="company-info">{{ _('company_cannot_buy_message') }} <a href="{{ url_for('company.company_products') }}">{{ _('my_products') }}</a>.</p>
                        {% else %}
                            <form method="POST" action="{{ url_for('main.add_to_cart') }}" class="add-to-cart-form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="product_id" value="{{ product.id }}">
                                
                                <label for="quantity-{{ product.id }}">{{ _('label_quantity') }}</label>
                                <input type="number" 
                                       id="quantity-{{ product.id }}" 
                                       name="quantity" 
                                       min="1" 
                                       max="{{ [5, product.stock]|min }}" 
                                       value="1" 
                                       title="{{ _('max_units_per_product') }} {{ product.stock }})"
                                       required
                                       class="quantity-input">
                                
                                <button type="submit" class="btn btn-primary">
                                    {{ _('add_to_cart') }}
                                </button>
                            </form>
                        {% endif %}
                    {% else %}
                        <p class="out-of-stock">{{ _('product_out_of_stock') }}</p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="no-products">{{ _('no_products_available') }}</p>
    {% endif %}
</div>
{% endblock %}