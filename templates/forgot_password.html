{% extends "base.html" %}

{% block title %}{{ _('recover_password') }} - TechShop{% endblock %}

{% block content %}
<div class="auth-container">
    <h2>{{ _('recover_password') }}</h2>
    
    {% if success %}
        <div class="password-recovery-success">
            <div class="success-icon">✓</div>
            <h3>{{ _('email_sent') }}</h3>
            <p class="success-message">{{ message }}</p>
            <div class="email-info">
                <p>{{ _('email_sent_message') }}</p>
                <div class="email-tips">
                    <h4>{{ _('recovery_tips') }}</h4>
                    <ul>
                        <li>{{ _('check_inbox') }}</li>
                        <li>{{ _('check_spam') }}</li>
                        <li>{{ _('email_delay') }}</li>
                        <li>{{ _('change_password_after') }}</li>
                    </ul>
                </div>
            </div>
            <div class="form-actions">
                <a href="{{ url_for('login') }}" class="btn btn-primary btn-large">
                    {{ _('go_to_login') }}
                </a>
                <a href="{{ url_for('show_products') }}" class="btn btn-secondary">
                    Tornar a {{ _('product_col') }}s
                </a>
            </div>
        </div>
    {% else %}
        <p class="recovery-info">{{ _('recovery_info') }}</p>
        
        <form method="POST" action="{{ url_for('forgot_password') }}" id="forgot-password-form" class="auth-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="form-group">
                <label for="dni">DNI/NIE:</label>
                <input type="text" 
                       id="dni" 
                       name="dni" 
                       pattern="^(\d{8}[A-Z]|[XYZ]\d{7}[A-Z])$"
                       title="Format: 8 números + lletra (DNI) o X/Y/Z + 7 números + lletra (NIE)"
                       required
                       class="form-input"
                       placeholder="12345678A o X1234567A"
                       autocomplete="off"
                       onblur="validateDNI_NIE(this)">
                <small>{{ _('help_dni') }}</small>
            </div>
            
            <div class="form-group">
                <label for="email">{{ _('label_email') }}</label>
                <input type="email" 
                       id="email" 
                       name="email" 
                       required
                       class="form-input"
                       placeholder="exemple@correu.com"
                       autocomplete="email"
                       onblur="validateEmail(this)">
                <small>{{ _('email_associated') }}</small>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-large">
                    {{ _('recover_password') }}
                </button>
                <a href="{{ url_for('login') }}" class="btn btn-secondary">
                    {{ _('back_to_login') }}
                </a>
                <a href="{{ url_for('show_products') }}" class="btn btn-link">
                    Tornar a {{ _('product_col') }}s
                </a>
            </div>
        </form>
    {% endif %}
</div>

<script>
// Traducciones para validación
const translations = {
    error_dni_invalid: {{ _('error_dni_invalid')|tojson }},
    error_nif_invalid: {{ _('error_nif_invalid')|tojson }},
    error_email_invalid: {{ _('error_email_invalid')|tojson }}
};

// Validar DNI/NIE en tiempo real
function validateDNI_NIE(input) {
    const value = input.value.trim().toUpperCase();
    if (value.length === 0) {
        clearFieldError(input);
        return;
    }
    
    if (typeof validarDNI_NIE === 'function' && !validarDNI_NIE(value)) {
        showFieldError(input, translations.error_dni_invalid);
    } else {
        clearFieldError(input);
    }
}

// Validar email en tiempo real
function validateEmail(input) {
    const value = input.value.trim().toLowerCase();
    if (value.length === 0) {
        clearFieldError(input);
        return;
    }
    
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(value)) {
        showFieldError(input, translations.error_email_invalid);
    } else {
        clearFieldError(input);
    }
}

</script>
{% endblock %}

